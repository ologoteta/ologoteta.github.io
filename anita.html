<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AnitaDraw</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f7;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 60px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
        }
        
        .tool-btn {
            width: 44px;
            height: 44px;
            margin: 4px 0;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .tool-btn:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.2);
        }
        
        .tool-btn.active {
            background: #007AFF;
            box-shadow: 0 0 15px rgba(0,122,255,0.5);
        }
        
        .tool-btn svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        
        .color-btn {
            width: 36px;
            height: 36px;
            margin: 3px 0;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .color-btn:active {
            transform: scale(0.9);
        }
        
        .color-btn.active {
            border: 3px solid #FFD700;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255,215,0,0.6);
        }
        
        .size-btn {
            width: 44px;
            height: 44px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        
        .divider {
            width: 80%;
            height: 1px;
            background: rgba(255,255,255,0.2);
            margin: 8px 0;
        }
        
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
        }
        
        #modal.show {
            display: block;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            max-height: 80%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007AFF;
        }
        
        .close-btn {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
        }
        
        .saved-item {
            border: 2px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .saved-preview {
            width: 100%;
            max-height: 150px;
            background: white;
            margin-bottom: 10px;
        }
        
        .saved-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            background: #007AFF;
            color: white;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin: 2px;
        }
        
        .btn:active {
            background: #0051D5;
        }
        
        #saveNameInput {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #007AFF;
            border-radius: 6px;
            font-size: 14px;
        }
        
        #colorPalette {
            display: none;
            position: fixed;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 1500;
        }
        
        #colorPalette.show {
            display: block;
        }
        
        #colorPalette .color-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .current-color-indicator {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid white;
            position: absolute;
            bottom: 2px;
            right: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .sidebar-spacer {
            flex: 1;
        }
        
        #settingsPanel {
            display: none;
            position: fixed;
            left: 70px;
            bottom: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 1500;
            min-width: 200px;
        }
        
        #settingsPanel.show {
            display: block;
        }
        
        #settingsPanel h3 {
            color: white;
            font-size: 14px;
            margin: 0 0 15px 0;
            font-weight: bold;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 8px;
        }
        
        .setting-option {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            width: 100%;
            transition: all 0.2s ease;
        }
        
        .setting-option:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .setting-option.active {
            background: #007AFF;
            border-color: #007AFF;
            box-shadow: 0 0 10px rgba(0,122,255,0.5);
        }
        
        #backgroundCanvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
            touch-action: none;
        }
        
        #canvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
            background: transparent;
            touch-action: none;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <!-- Tool: Pen -->
        <button class="tool-btn active" id="penBtn" title="Penna">
            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
        </button>
        
        <!-- Tool: Eraser -->
        <button class="tool-btn" id="eraserBtn" title="Gomma">
            <svg viewBox="0 0 24 24"><path d="M16.24 3.56l4.95 4.94c.78.79.78 2.05 0 2.84L12 20.53a4.008 4.008 0 0 1-5.66 0L2.81 17c-.78-.79-.78-2.05 0-2.84l10.6-10.6c.79-.78 2.05-.78 2.83 0M4.22 15.58l3.54 3.53c.78.79 2.04.79 2.83 0l3.53-3.53-6.36-6.36-3.54 3.53c-.78.79-.78 2.05 0 2.83z"/></svg>
        </button>
        
        <div class="divider"></div>
        
        <!-- Color Palette Button -->
        <button class="tool-btn" id="colorPaletteBtn" title="Colori" style="position:relative;">
            <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
            <span class="current-color-indicator" id="currentColorIndicator" style="background:#000000"></span>
        </button>
        
        <div class="divider"></div>
        
        <!-- Brush Sizes -->
        <button class="tool-btn size-btn active" data-size="4" title="S">S</button>
        <button class="tool-btn size-btn" data-size="10" title="M">M</button>
        <button class="tool-btn size-btn" data-size="20" title="L">L</button>
        
        <div class="divider"></div>
        
        <!-- Actions -->
        <button class="tool-btn" id="undoBtn" title="Annulla">
            <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
        </button>
        
        <button class="tool-btn" id="newBtn" title="Nuovo">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </button>
        
        <button class="tool-btn" id="saveBtn" title="Salva">
            <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
        </button>
        
        <button class="tool-btn" id="loadBtn" title="Carica">
            <svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/></svg>
        </button>
        
        <div class="sidebar-spacer"></div>
        
        <!-- Settings Button -->
        <button class="tool-btn" id="settingsBtn" title="Impostazioni">
            <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
        </button>
    </div>
    
    <!-- Settings Panel -->
    <div id="settingsPanel">
        <h3>Sfondo</h3>
        <button class="setting-option active" data-background="white">üìÑ Foglio Bianco</button>
        <button class="setting-option" data-background="lines">üìè A Righe</button>
        <button class="setting-option" data-background="grid">‚äû A Quadretti</button>
    </div>
    
    <!-- Color Palette Popup -->
    <div id="colorPalette">
        <div class="color-grid">
            <button class="color-btn active" style="background:#000000" data-color="#000000" title="Nero"></button>
            <button class="color-btn" style="background:#FF0000" data-color="#FF0000" title="Rosso"></button>
            <button class="color-btn" style="background:#00FF00" data-color="#00FF00" title="Verde"></button>
            <button class="color-btn" style="background:#0000FF" data-color="#0000FF" title="Blu"></button>
            <button class="color-btn" style="background:#FFFF00" data-color="#FFFF00" title="Giallo"></button>
            <button class="color-btn" style="background:#FF00FF" data-color="#FF00FF" title="Magenta"></button>
            <button class="color-btn" style="background:#00FFFF" data-color="#00FFFF" title="Ciano"></button>
            <button class="color-btn" style="background:#FFA500" data-color="#FFA500" title="Arancione"></button>
            <button class="color-btn" style="background:#8B4513" data-color="#8B4513" title="Marrone"></button>
        </div>
    </div>
    
    <canvas id="backgroundCanvas"></canvas>
    <canvas id="canvas"></canvas>
    
    <div id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" id="closeModal">&times;</button>
                <span id="modalTitle">Modal</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        var backgroundCanvas = document.getElementById('backgroundCanvas');
        var bgCtx = backgroundCanvas.getContext('2d');
        var isDrawing = false;
        var currentTool = 'pen';
        var currentColor = '#000000';
        var brushSize = 4;
        var points = [];
        var undoStack = [];
        var maxUndoSteps = 15;
        var modal = document.getElementById('modal');
        var currentBackground = 'white';
        
        // Setup canvas
        function resizeCanvas() {
            var sidebar = document.getElementById('sidebar');
            var sidebarWidth = sidebar.offsetWidth;
            
            // Resize both canvases
            canvas.width = window.innerWidth - sidebarWidth;
            canvas.height = window.innerHeight;
            canvas.style.left = sidebarWidth + 'px';
            
            backgroundCanvas.width = window.innerWidth - sidebarWidth;
            backgroundCanvas.height = window.innerHeight;
            backgroundCanvas.style.left = sidebarWidth + 'px';
            
            // Set smoothing properties
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.imageSmoothingEnabled = true;
            
            // Redraw background
            drawBackground(currentBackground);
            
            if (undoStack.length > 0) {
                restoreFromDataURL(undoStack[undoStack.length - 1]);
            }
        }
        
        // Draw background patterns
        function drawBackground(type) {
            currentBackground = type;
            bgCtx.fillStyle = 'white';
            bgCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            
            if (type === 'lines') {
                // Draw horizontal lines
                bgCtx.strokeStyle = '#E0E0E0';
                bgCtx.lineWidth = 1;
                bgCtx.beginPath();
                
                var lineSpacing = 30;
                for (var y = lineSpacing; y < backgroundCanvas.height; y += lineSpacing) {
                    bgCtx.moveTo(0, y);
                    bgCtx.lineTo(backgroundCanvas.width, y);
                }
                
                bgCtx.stroke();
                
                // Draw red margin line
                bgCtx.strokeStyle = '#FFB6C1';
                bgCtx.lineWidth = 2;
                bgCtx.beginPath();
                bgCtx.moveTo(40, 0);
                bgCtx.lineTo(40, backgroundCanvas.height);
                bgCtx.stroke();
                
            } else if (type === 'grid') {
                // Draw grid
                bgCtx.strokeStyle = '#E0E0E0';
                bgCtx.lineWidth = 1;
                bgCtx.beginPath();
                
                var gridSpacing = 20;
                
                // Vertical lines
                for (var x = gridSpacing; x < backgroundCanvas.width; x += gridSpacing) {
                    bgCtx.moveTo(x, 0);
                    bgCtx.lineTo(x, backgroundCanvas.height);
                }
                
                // Horizontal lines
                for (var y = gridSpacing; y < backgroundCanvas.height; y += gridSpacing) {
                    bgCtx.moveTo(0, y);
                    bgCtx.lineTo(backgroundCanvas.width, y);
                }
                
                bgCtx.stroke();
                
                // Draw thicker lines every 5 squares
                bgCtx.strokeStyle = '#C0C0C0';
                bgCtx.lineWidth = 1.5;
                bgCtx.beginPath();
                
                var majorSpacing = gridSpacing * 5;
                
                for (var x = majorSpacing; x < backgroundCanvas.width; x += majorSpacing) {
                    bgCtx.moveTo(x, 0);
                    bgCtx.lineTo(x, backgroundCanvas.height);
                }
                
                for (var y = majorSpacing; y < backgroundCanvas.height; y += majorSpacing) {
                    bgCtx.moveTo(0, y);
                    bgCtx.lineTo(backgroundCanvas.width, y);
                }
                
                bgCtx.stroke();
            }
            
            // Save preference
            try {
                window.localStorage.setItem('background', type);
            } catch (e) {
                // Ignore storage errors
            }
        }
        
        // Load saved background preference
        try {
            var savedBackground = window.localStorage.getItem('background');
            if (savedBackground) {
                currentBackground = savedBackground;
            }
        } catch (e) {
            // Ignore storage errors
        }
        
        resizeCanvas();
        
        var resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(resizeCanvas, 100);
        });
        
        // Save state for undo
        function saveState() {
            undoStack.push(canvas.toDataURL());
            if (undoStack.length > maxUndoSteps) {
                undoStack.shift();
            }
        }
        
        function restoreFromDataURL(dataURL) {
            var img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = dataURL;
        }
        
        // Get coordinates
        function getCoords(e) {
            var rect = canvas.getBoundingClientRect();
            var clientX, clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }
        
        // Smooth drawing during the stroke (preview)
        var lastDrawnIndex = 0;
        var tempCanvas = document.createElement('canvas');
        var tempCtx = tempCanvas.getContext('2d');
        
        function drawSmooth() {
            if (points.length < 2) return;
            
            if (currentTool === 'pen') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize;
                ctx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'eraser') {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = brushSize * 3;
                ctx.globalCompositeOperation = 'destination-out';
            }
            
            // Draw only new segments
            if (lastDrawnIndex === 0) {
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
            }
            
            // Use cubic Bezier curves for smoother lines
            for (var i = lastDrawnIndex; i < points.length - 1; i++) {
                var p0 = points[Math.max(0, i - 1)];
                var p1 = points[i];
                var p2 = points[i + 1];
                var p3 = points[Math.min(points.length - 1, i + 2)];
                
                // Calculate control points for cubic Bezier
                var cp1x = p1.x + (p2.x - p0.x) / 6;
                var cp1y = p1.y + (p2.y - p0.y) / 6;
                var cp2x = p2.x - (p3.x - p1.x) / 6;
                var cp2y = p2.y - (p3.y - p1.y) / 6;
                
                ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
            }
            
            ctx.stroke();
            lastDrawnIndex = Math.max(0, points.length - 2);
        }
        
        // Smooth the collected points with moderate averaging
        function smoothPoints(pts, iterations) {
            if (pts.length < 3) return pts;
            
            var smoothed = [];
            for (var iter = 0; iter < iterations; iter++) {
                var source = (iter === 0) ? pts : smoothed;
                smoothed = [];
                
                // Keep first point
                smoothed.push(source[0]);
                
                // Average middle points with narrow window for gentle smoothing
                for (var i = 1; i < source.length - 1; i++) {
                    var x = 0;
                    var y = 0;
                    var count = 0;
                    
                    // Use 3-point window for gentler smoothing
                    for (var j = Math.max(0, i - 1); j <= Math.min(source.length - 1, i + 1); j++) {
                        var weight = 1;
                        if (j === i) weight = 2; // Give more weight to center point to preserve shape
                        x += source[j].x * weight;
                        y += source[j].y * weight;
                        count += weight;
                    }
                    
                    smoothed.push({
                        x: x / count,
                        y: y / count
                    });
                }
                
                // Keep last point
                smoothed.push(source[source.length - 1]);
            }
            
            return smoothed;
        }
        
        // Reduce number of points while maintaining shape (gentle)
        function simplifyPoints(pts) {
            if (pts.length <= 4) return pts;
            
            var simplified = [pts[0]];
            
            // Skip fewer points to preserve more detail
            for (var i = 1; i < pts.length - 1; i += 2) {
                simplified.push(pts[i]);
            }
            
            simplified.push(pts[pts.length - 1]);
            return simplified;
        }
        
        // Final smooth redraw with moderate anti-aliasing
        function finalizeStroke(pts) {
            if (pts.length < 2) return;
            
            // First simplify to remove redundant points
            var simplified = simplifyPoints(pts);
            
            // Apply moderate smoothing (fewer iterations)
            var smoothedPts = smoothPoints(simplified, 3);
            
            // Ensure smooth rendering properties
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (currentTool === 'pen') {
                // Draw outer glow layer (moderate)
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize + 1;
                ctx.globalCompositeOperation = 'source-over';
                ctx.shadowBlur = brushSize * 0.8;
                ctx.shadowColor = currentColor;
                ctx.globalAlpha = 0.3;
            } else if (currentTool === 'eraser') {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = brushSize * 3;
                ctx.globalCompositeOperation = 'destination-out';
                ctx.shadowBlur = brushSize;
                ctx.shadowColor = 'rgba(0,0,0,0.5)';
            }
            
            ctx.beginPath();
            ctx.moveTo(smoothedPts[0].x, smoothedPts[0].y);
            
            // Draw with smooth Catmull-Rom curves (moderate tension)
            var tension = 0.5;
            for (var i = 0; i < smoothedPts.length - 1; i++) {
                var p0 = smoothedPts[Math.max(0, i - 1)];
                var p1 = smoothedPts[i];
                var p2 = smoothedPts[i + 1];
                var p3 = smoothedPts[Math.min(smoothedPts.length - 1, i + 2)];
                
                var cp1x = p1.x + (p2.x - p0.x) * tension / 6;
                var cp1y = p1.y + (p2.y - p0.y) * tension / 6;
                var cp2x = p2.x - (p3.x - p1.x) * tension / 6;
                var cp2y = p2.y - (p3.y - p1.y) * tension / 6;
                
                ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
            }
            
            ctx.stroke();
            
            // Draw main stroke (solid core)
            if (currentTool === 'pen') {
                ctx.globalAlpha = 1;
                ctx.shadowBlur = brushSize * 0.3;
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize;
                ctx.globalCompositeOperation = 'source-over';
            }
            
            ctx.beginPath();
            ctx.moveTo(smoothedPts[0].x, smoothedPts[0].y);
            
            for (var i = 0; i < smoothedPts.length - 1; i++) {
                var p0 = smoothedPts[Math.max(0, i - 1)];
                var p1 = smoothedPts[i];
                var p2 = smoothedPts[i + 1];
                var p3 = smoothedPts[Math.min(smoothedPts.length - 1, i + 2)];
                
                var cp1x = p1.x + (p2.x - p0.x) * tension / 6;
                var cp1y = p1.y + (p2.y - p0.y) * tension / 6;
                var cp2x = p2.x - (p3.x - p1.x) * tension / 6;
                var cp2y = p2.y - (p3.y - p1.y) * tension / 6;
                
                ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
            }
            
            ctx.stroke();
            
            // Reset properties
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
            ctx.globalAlpha = 1;
        }
        
        // Filter points that are too close together
        function addPoint(point) {
            if (points.length === 0) {
                points.push(point);
                return;
            }
            
            var last = points[points.length - 1];
            var dx = point.x - last.x;
            var dy = point.y - last.y;
            var distance = Math.sqrt(dx * dx + dy * dy);
            
            // Add more points for better smoothing (lower threshold)
            if (distance > 1) {
                points.push(point);
            }
        }
        
        // Drawing functions
        var drawingStartState = null;
        
        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            points = [];
            lastDrawnIndex = 0;
            var coords = getCoords(e);
            points.push(coords);
            
            // Save state before drawing
            drawingStartState = canvas.toDataURL();
            
            // Draw initial point
            if (currentTool === 'pen') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize;
                ctx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'eraser') {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = brushSize * 3;
                ctx.globalCompositeOperation = 'destination-out';
            }
            ctx.beginPath();
            ctx.arc(coords.x, coords.y, brushSize / 2, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            var coords = getCoords(e);
            addPoint(coords);
            
            if (points.length >= 2) {
                drawSmooth();
            }
        }
        
        function stopDrawing(e) {
            if (isDrawing) {
                e.preventDefault();
                isDrawing = false;
                
                // Restore to pre-drawing state
                if (drawingStartState && points.length >= 2) {
                    var img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        
                        // Draw final smoothed and anti-aliased stroke
                        finalizeStroke(points);
                        
                        // Save for undo
                        saveState();
                        
                        points = [];
                        lastDrawnIndex = 0;
                        drawingStartState = null;
                    };
                    img.src = drawingStartState;
                } else {
                    // Single point or very short stroke
                    saveState();
                    points = [];
                    lastDrawnIndex = 0;
                    drawingStartState = null;
                }
            }
        }
        
        // Events
        canvas.addEventListener('touchstart', startDrawing, false);
        canvas.addEventListener('touchmove', draw, false);
        canvas.addEventListener('touchend', stopDrawing, false);
        canvas.addEventListener('touchcancel', stopDrawing, false);
        
        canvas.addEventListener('mousedown', startDrawing, false);
        canvas.addEventListener('mousemove', draw, false);
        canvas.addEventListener('mouseup', stopDrawing, false);
        canvas.addEventListener('mouseleave', stopDrawing, false);
        
        // Tool buttons
        document.getElementById('penBtn').addEventListener('click', function() {
            currentTool = 'pen';
            this.className = 'tool-btn active';
            document.getElementById('eraserBtn').className = 'tool-btn';
        });
        
        document.getElementById('eraserBtn').addEventListener('click', function() {
            currentTool = 'eraser';
            this.className = 'tool-btn active';
            document.getElementById('penBtn').className = 'tool-btn';
        });
        
        // Color Palette
        var colorPalette = document.getElementById('colorPalette');
        var colorPaletteBtn = document.getElementById('colorPaletteBtn');
        var currentColorIndicator = document.getElementById('currentColorIndicator');
        
        // Toggle color palette
        colorPaletteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (colorPalette.className === 'show') {
                colorPalette.className = '';
            } else {
                colorPalette.className = 'show';
            }
        });
        
        // Close palette when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== colorPaletteBtn && !colorPalette.contains(e.target)) {
                colorPalette.className = '';
            }
        });
        
        // Color selection
        var colorBtns = document.querySelectorAll('#colorPalette .color-btn');
        for (var i = 0; i < colorBtns.length; i++) {
            colorBtns[i].addEventListener('click', function() {
                currentColor = this.getAttribute('data-color');
                currentTool = 'pen';
                document.getElementById('penBtn').className = 'tool-btn active';
                document.getElementById('eraserBtn').className = 'tool-btn';
                
                // Update color indicator
                currentColorIndicator.style.background = currentColor;
                
                // Update active state
                var allColorBtns = document.querySelectorAll('#colorPalette .color-btn');
                for (var j = 0; j < allColorBtns.length; j++) {
                    allColorBtns[j].className = 'color-btn';
                }
                this.className = 'color-btn active';
                
                // Close palette
                colorPalette.className = '';
            });
        }
        
        // Size buttons
        var sizeBtns = document.querySelectorAll('.size-btn');
        for (var i = 0; i < sizeBtns.length; i++) {
            sizeBtns[i].addEventListener('click', function() {
                brushSize = parseInt(this.getAttribute('data-size'));
                
                var allSizeBtns = document.querySelectorAll('.size-btn');
                for (var j = 0; j < allSizeBtns.length; j++) {
                    allSizeBtns[j].className = 'tool-btn size-btn';
                }
                this.className = 'tool-btn size-btn active';
            });
        }
        
        // Settings Panel
        var settingsPanel = document.getElementById('settingsPanel');
        var settingsBtn = document.getElementById('settingsBtn');
        
        // Toggle settings panel
        settingsBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (settingsPanel.className === 'show') {
                settingsPanel.className = '';
            } else {
                settingsPanel.className = 'show';
                // Close color palette if open
                colorPalette.className = '';
            }
        });
        
        // Close settings when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== settingsBtn && !settingsPanel.contains(e.target)) {
                settingsPanel.className = '';
            }
        });
        
        // Background selection
        var bgBtns = document.querySelectorAll('.setting-option');
        for (var i = 0; i < bgBtns.length; i++) {
            bgBtns[i].addEventListener('click', function() {
                var bgType = this.getAttribute('data-background');
                drawBackground(bgType);
                
                // Update active state
                var allBgBtns = document.querySelectorAll('.setting-option');
                for (var j = 0; j < allBgBtns.length; j++) {
                    allBgBtns[j].className = 'setting-option';
                }
                this.className = 'setting-option active';
            });
        }
        
        // Set initial active background button
        var savedBg = currentBackground;
        var allBgBtns = document.querySelectorAll('.setting-option');
        for (var i = 0; i < allBgBtns.length; i++) {
            if (allBgBtns[i].getAttribute('data-background') === savedBg) {
                allBgBtns[i].className = 'setting-option active';
            } else {
                allBgBtns[i].className = 'setting-option';
            }
        }
        
        // New button
        document.getElementById('newBtn').addEventListener('click', function() {
            if (confirm('Vuoi creare un nuovo disegno? Non salvato = perso!')) {
                undoStack = [];
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        });
        
        // Undo button
        document.getElementById('undoBtn').addEventListener('click', function() {
            if (undoStack.length > 1) {
                undoStack.pop();
                restoreFromDataURL(undoStack[undoStack.length - 1]);
            } else if (undoStack.length === 1) {
                undoStack.pop();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        });
        
        // Modal functions
        function openModal() {
            modal.className = 'show';
        }
        
        function closeModal() {
            modal.className = '';
        }
        
        document.getElementById('closeModal').addEventListener('click', closeModal);
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // localStorage functions
        function getAllDrawings() {
            try {
                var drawings = window.localStorage.getItem('drawings');
                return drawings ? JSON.parse(drawings) : [];
            } catch (e) {
                return [];
            }
        }
        
        function saveAllDrawings(drawings) {
            try {
                window.localStorage.setItem('drawings', JSON.stringify(drawings));
            } catch (e) {
                alert('Errore nel salvataggio');
            }
        }
        
        // Save button
        document.getElementById('saveBtn').addEventListener('click', function() {
            var modalBody = document.getElementById('modalBody');
            document.getElementById('modalTitle').textContent = 'Salva Disegno';
            
            modalBody.innerHTML = '<input type="text" id="saveNameInput" placeholder="Nome del disegno"><br><br>' +
                '<button class="btn" id="confirmSave">Salva</button>';
            
            openModal();
            
            document.getElementById('confirmSave').addEventListener('click', function() {
                var name = document.getElementById('saveNameInput').value;
                if (!name || name === '') {
                    var now = new Date();
                    name = 'Disegno ' + now.getDate() + '/' + (now.getMonth()+1) + ' ' + now.getHours() + ':' + now.getMinutes();
                }
                
                var dataURL = canvas.toDataURL('image/png');
                var drawings = getAllDrawings();
                
                drawings.push({
                    id: new Date().getTime(),
                    name: name,
                    data: dataURL,
                    date: new Date().toISOString()
                });
                
                saveAllDrawings(drawings);
                alert('Disegno salvato!');
                closeModal();
            });
        });
        
        // Load button
        document.getElementById('loadBtn').addEventListener('click', function() {
            var drawings = getAllDrawings();
            var modalBody = document.getElementById('modalBody');
            document.getElementById('modalTitle').textContent = 'I Miei Disegni';
            
            if (drawings.length === 0) {
                modalBody.innerHTML = '<p style="padding:20px;text-align:center">Nessun disegno salvato</p>';
            } else {
                var html = '';
                for (var i = drawings.length - 1; i >= 0; i--) {
                    var drawing = drawings[i];
                    var date = new Date(drawing.date);
                    var dateStr = date.getDate() + '/' + (date.getMonth()+1) + '/' + date.getFullYear() + ' ' + 
                                  date.getHours() + ':' + (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
                    
                    html += '<div class="saved-item">' +
                        '<img src="' + drawing.data + '" class="saved-preview">' +
                        '<div class="saved-info"><strong>' + drawing.name + '</strong><br>' + dateStr + '</div>' +
                        '<button class="btn" onclick="loadDrawing(' + drawing.id + ')">Carica</button> ' +
                        '<button class="btn" onclick="downloadDrawing(' + drawing.id + ')">Scarica</button> ' +
                        '<button class="btn" onclick="deleteDrawing(' + drawing.id + ')">Elimina</button>' +
                        '</div>';
                }
                modalBody.innerHTML = html;
            }
            
            openModal();
        });
        
        // Global functions for onclick
        function loadDrawing(id) {
            var drawings = getAllDrawings();
            for (var i = 0; i < drawings.length; i++) {
                if (drawings[i].id === id) {
                    restoreFromDataURL(drawings[i].data);
                    saveState();
                    closeModal();
                    return;
                }
            }
        }
        
        function downloadDrawing(id) {
            var drawings = getAllDrawings();
            for (var i = 0; i < drawings.length; i++) {
                if (drawings[i].id === id) {
                    var link = document.createElement('a');
                    link.download = drawings[i].name + '.png';
                    link.href = drawings[i].data;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    return;
                }
            }
        }
        
        function deleteDrawing(id) {
            if (confirm('Vuoi eliminare questo disegno?')) {
                var drawings = getAllDrawings();
                var newDrawings = [];
                for (var i = 0; i < drawings.length; i++) {
                    if (drawings[i].id !== id) {
                        newDrawings.push(drawings[i]);
                    }
                }
                saveAllDrawings(newDrawings);
                document.getElementById('loadBtn').click();
            }
        }
        
        // Prevent scrolling
        document.body.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, false);
    </script>
</body>
</html>
