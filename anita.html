<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AnitaDraw</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f7;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 60px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
        }
        
        .tool-btn {
            width: 44px;
            height: 44px;
            margin: 4px 0;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .tool-btn:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.2);
        }
        
        .tool-btn.active {
            background: #007AFF;
            box-shadow: 0 0 15px rgba(0,122,255,0.5);
        }
        
        .tool-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
            display: block;
            margin: 0 auto;
        }
        
        .color-btn {
            width: 40px;
            height: 40px;
            margin: 0;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .color-btn[data-color="#FFFFFF"] {
            border: 2px solid rgba(0,0,0,0.3);
        }
        
        .color-btn:active {
            transform: scale(0.9);
        }
        
        .color-btn.active {
            border: 3px solid #FFD700;
            transform: scale(1.05);
            box-shadow: 0 0 12px rgba(255,215,0,0.8);
        }
        
        .size-btn {
            width: 44px;
            height: 44px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1;
        }
            
            .divider {
            width: 80%;
            height: 1px;
            background: rgba(255,255,255,0.2);
            margin: 8px 0;
        }
        
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
        }
        
        #modal.show {
            display: block;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            max-height: 80%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007AFF;
        }
        
        .close-btn {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
        }
        
        .saved-item {
            border: 2px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .saved-preview {
            width: 100%;
            max-height: 150px;
            background: white;
            margin-bottom: 10px;
        }
        
        .saved-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            background: #007AFF;
            color: white;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin: 2px;
        }
        
        .btn:active {
            background: #0051D5;
        }
        
        #saveNameInput {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #007AFF;
            border-radius: 6px;
            font-size: 14px;
        }
        
        #colorPalette {
            display: none;
            position: fixed;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 1500;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        #colorPalette.show {
            display: block;
        }
        
        #colorPalette .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        
        .sidebar-spacer {
            flex: 1;
        }
        
        #settingsPanel {
            display: none;
            position: fixed;
            left: 70px;
            bottom: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 1500;
            min-width: 200px;
        }
        
        #settingsPanel.show {
            display: block;
        }
        
        #settingsPanel h3 {
            color: white;
            font-size: 14px;
            margin: 0 0 15px 0;
            font-weight: bold;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 8px;
        }
        
        .setting-option {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            width: 100%;
            transition: all 0.2s ease;
        }
        
        .setting-option:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .setting-option.active {
            background: #007AFF;
            border-color: #007AFF;
            box-shadow: 0 0 10px rgba(0,122,255,0.5);
        }
        
        #backgroundCanvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
            touch-action: none;
        }
        
        #canvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
            background: transparent;
            touch-action: none;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <!-- Tool: Pen -->
        <button class="tool-btn active" id="penBtn" title="Penna">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/></svg>
        </button>
        
        <!-- Tool: Eraser -->
        <button class="tool-btn" id="eraserBtn" title="Gomma">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><rect x="2" y="8" width="16" height="8" rx="2" fill="currentColor"/><path d="M6 8l4-4h8l-4 4H6z" fill="currentColor"/></svg>
        </button>
        
        <!-- Tool: Fill Bucket -->
        <button class="tool-btn" id="fillBtn" title="Secchiello">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><path d="M19,11.5C19,11.5 17,13.67 17,15A2,2 0 0,0 19,17A2,2 0 0,0 21,15C21,13.67 19,11.5 19,11.5M5.21,10L10,5.21L14.79,10M16.56,8.94L7.62,0L6.21,1.41L8.59,3.79L3.44,8.94C2.85,9.5 2.85,10.47 3.44,11.06L8.94,16.56C9.23,16.85 9.62,17 10,17C10.38,17 10.77,16.85 11.06,16.56L16.56,11.06C17.15,10.47 17.15,9.5 16.56,8.94Z" fill="currentColor"/></svg>
        </button>
        
        <!-- Tool: Gradient Fill -->
        <button class="tool-btn" id="gradientFillBtn" title="Secchiello Sfumatura">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><defs><linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:currentColor;stop-opacity:1" /><stop offset="100%" style="stop-color:currentColor;stop-opacity:0.3" /></linearGradient></defs><path d="M19,11.5C19,11.5 17,13.67 17,15A2,2 0 0,0 19,17A2,2 0 0,0 21,15C21,13.67 19,11.5 19,11.5M5.21,10L10,5.21L14.79,10M16.56,8.94L7.62,0L6.21,1.41L8.59,3.79L3.44,8.94C2.85,9.5 2.85,10.47 3.44,11.06L8.94,16.56C9.23,16.85 9.62,17 10,17C10.38,17 10.77,16.85 11.06,16.56L16.56,11.06C17.15,10.47 17.15,9.5 16.56,8.94Z" fill="url(#gradient)"/></svg>
        </button>
        
        <!-- Tool: Highlighter -->
        <button class="tool-btn" id="highlighterBtn" title="Evidenziatore">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><rect x="3" y="8" width="18" height="4" rx="2" fill="currentColor" opacity="0.6"/><rect x="5" y="6" width="14" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1"/></svg>
        </button>
        
        <div class="divider"></div>
        
        <!-- Primary Color Button -->
        <button class="tool-btn" id="primaryColorBtn" title="Colore Primario">
            <div style="width:24px; height:24px; border-radius:50%; background:#000000; border:2px solid rgba(255,255,255,0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.4);"></div>
        </button>
        
        <!-- Secondary Color Button -->
        <button class="tool-btn" id="secondaryColorBtn" title="Colore Secondario">
            <div style="width:24px; height:24px; border-radius:50%; background:#FFFFFF; border:2px solid rgba(0,0,0,0.5); box-shadow: 0 2px 5px rgba(0,0,0,0.4);"></div>
        </button>
        
        <!-- Color Palette Button -->
        <button class="tool-btn" id="colorPaletteBtn" title="Palette Colori">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z" fill="currentColor"/></svg>
        </button>
        
        <div class="divider"></div>
        
        <!-- Brush Sizes -->
        <button class="tool-btn size-btn active" data-size="4" title="S">S</button>
        <button class="tool-btn size-btn" data-size="10" title="M">M</button>
        <button class="tool-btn size-btn" data-size="20" title="L">L</button>
        
        <div class="divider"></div>
        
        <!-- Actions -->
        <button class="tool-btn" id="undoBtn" title="Annulla">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z" fill="currentColor"/></svg>
        </button>
        
        <button class="tool-btn" id="newBtn" title="Nuovo">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor"/></svg>
        </button>
        
        
        <button class="tool-btn" id="loadBtn" title="Carica">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z" fill="currentColor"/></svg>
        </button>
        
        <button class="tool-btn" id="downloadBtn" title="Scarica">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><path d="M19 9h-4V3H9v6H5l7 7 7-7z" fill="currentColor"/></svg>
        </button>
        
        <div class="sidebar-spacer"></div>
        
        <!-- Settings Button -->
        <button class="tool-btn" id="settingsBtn" title="Impostazioni">
            <svg viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;"><circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" fill="currentColor"/></svg>
        </button>
    </div>
    
    <!-- Settings Panel -->
    <div id="settingsPanel">
        <h3>Sfondo</h3>
        <button class="setting-option active" data-background="white">📄 Foglio Bianco</button>
        <button class="setting-option" data-background="lines">📏 A Righe</button>
        <button class="setting-option" data-background="grid">⊞ A Quadretti</button>
    </div>
    
    <!-- Color Palette Popup -->
    <div id="colorPalette">
        <div class="color-grid">
            <!-- Row 1: Base colors -->
            <button class="color-btn active" style="background:#000000" data-color="#000000" title="Nero"></button>
            <button class="color-btn" style="background:#FFFFFF" data-color="#FFFFFF" title="Bianco"></button>
            <button class="color-btn" style="background:#808080" data-color="#808080" title="Grigio"></button>
            <button class="color-btn" style="background:#C0C0C0" data-color="#C0C0C0" title="Argento"></button>
            
            <!-- Row 2: Primary colors -->
            <button class="color-btn" style="background:#FF0000" data-color="#FF0000" title="Rosso"></button>
            <button class="color-btn" style="background:#00FF00" data-color="#00FF00" title="Verde Lime"></button>
            <button class="color-btn" style="background:#0000FF" data-color="#0000FF" title="Blu"></button>
            <button class="color-btn" style="background:#FFFF00" data-color="#FFFF00" title="Giallo"></button>
            
            <!-- Row 3: Secondary colors -->
            <button class="color-btn" style="background:#FF00FF" data-color="#FF00FF" title="Magenta"></button>
            <button class="color-btn" style="background:#00FFFF" data-color="#00FFFF" title="Ciano"></button>
            <button class="color-btn" style="background:#FFA500" data-color="#FFA500" title="Arancione"></button>
            <button class="color-btn" style="background:#800080" data-color="#800080" title="Viola"></button>
            
            <!-- Row 4: Earth tones -->
            <button class="color-btn" style="background:#8B4513" data-color="#8B4513" title="Marrone"></button>
            <button class="color-btn" style="background:#D2691E" data-color="#D2691E" title="Cioccolato"></button>
            <button class="color-btn" style="background:#F4A460" data-color="#F4A460" title="Beige"></button>
            <button class="color-btn" style="background:#DEB887" data-color="#DEB887" title="Sabbia"></button>
            
            <!-- Row 5: Additional colors -->
            <button class="color-btn" style="background:#FF1493" data-color="#FF1493" title="Rosa"></button>
            <button class="color-btn" style="background:#00CED1" data-color="#00CED1" title="Turchese"></button>
            <button class="color-btn" style="background:#9370DB" data-color="#9370DB" title="Lavanda"></button>
            <button class="color-btn" style="background:#32CD32" data-color="#32CD32" title="Verde"></button>
            
            <!-- Row 6: COLORI FLUO / EVIDENZIATORE -->
            <button class="color-btn" style="background:#FFED00; box-shadow:0 0 15px #FFED00" data-color="#FFED00" title="⚡ Giallo Fluo"></button>
            <button class="color-btn" style="background:#39FF14; box-shadow:0 0 15px #39FF14" data-color="#39FF14" title="⚡ Verde Fluo"></button>
            <button class="color-btn" style="background:#FF006E; box-shadow:0 0 15px #FF006E" data-color="#FF006E" title="⚡ Rosa Fluo"></button>
            <button class="color-btn" style="background:#FF5F00; box-shadow:0 0 15px #FF5F00" data-color="#FF5F00" title="⚡ Arancione Fluo"></button>
            
            <!-- Row 7: Più colori FLUO -->
            <button class="color-btn" style="background:#00F0FF; box-shadow:0 0 15px #00F0FF" data-color="#00F0FF" title="⚡ Ciano Fluo"></button>
            <button class="color-btn" style="background:#CCFF00; box-shadow:0 0 15px #CCFF00" data-color="#CCFF00" title="⚡ Lime Fluo"></button>
            <button class="color-btn" style="background:#FF10F0; box-shadow:0 0 15px #FF10F0" data-color="#FF10F0" title="⚡ Magenta Fluo"></button>
            <button class="color-btn" style="background:#FE019A; box-shadow:0 0 15px #FE019A" data-color="#FE019A" title="⚡ Fucsia Fluo"></button>
        </div>
    </div>
    
    <canvas id="backgroundCanvas"></canvas>
    <canvas id="canvas"></canvas>
    
    <div id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" id="closeModal">&times;</button>
                <span id="modalTitle">Modal</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        var backgroundCanvas = document.getElementById('backgroundCanvas');
        var bgCtx = backgroundCanvas.getContext('2d');
        var isDrawing = false;
        var currentTool = 'pen';
        var primaryColor = '#000000';
        var secondaryColor = '#FFFFFF';
        var activeColorSlot = 'primary';
        var currentColor = primaryColor;
        var brushSize = 4;
        var points = [];
        var undoStack = [];
        var maxUndoSteps = 15;
        var modal = document.getElementById('modal');
        var currentBackground = 'white';
        
        // Setup canvas
        function resizeCanvas() {
            var sidebar = document.getElementById('sidebar');
            var sidebarWidth = sidebar.offsetWidth;
            
            // Resize both canvases
            canvas.width = window.innerWidth - sidebarWidth;
            canvas.height = window.innerHeight;
            canvas.style.left = sidebarWidth + 'px';
            
            backgroundCanvas.width = window.innerWidth - sidebarWidth;
            backgroundCanvas.height = window.innerHeight;
            backgroundCanvas.style.left = sidebarWidth + 'px';
            
            // Set smoothing properties
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.imageSmoothingEnabled = true;
            
            // Redraw background
            drawBackground(currentBackground);
            
            if (undoStack.length > 0) {
                restoreFromDataURL(undoStack[undoStack.length - 1]);
            }
        }
        
        // Draw background patterns
        function drawBackground(type) {
            currentBackground = type;
            bgCtx.fillStyle = 'white';
            bgCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            
            if (type === 'lines') {
                // Draw horizontal lines
                bgCtx.strokeStyle = '#E0E0E0';
                bgCtx.lineWidth = 1;
                bgCtx.beginPath();
                
                var lineSpacing = 30;
                for (var y = lineSpacing; y < backgroundCanvas.height; y += lineSpacing) {
                    bgCtx.moveTo(0, y);
                    bgCtx.lineTo(backgroundCanvas.width, y);
                }
                
                bgCtx.stroke();
                
                // Draw red margin line
                bgCtx.strokeStyle = '#FFB6C1';
                bgCtx.lineWidth = 2;
                bgCtx.beginPath();
                bgCtx.moveTo(40, 0);
                bgCtx.lineTo(40, backgroundCanvas.height);
                bgCtx.stroke();
                
            } else if (type === 'grid') {
                // Draw grid
                bgCtx.strokeStyle = '#E0E0E0';
                bgCtx.lineWidth = 1;
                bgCtx.beginPath();
                
                var gridSpacing = 20;
                
                // Vertical lines
                for (var x = gridSpacing; x < backgroundCanvas.width; x += gridSpacing) {
                    bgCtx.moveTo(x, 0);
                    bgCtx.lineTo(x, backgroundCanvas.height);
                }
                
                // Horizontal lines
                for (var y = gridSpacing; y < backgroundCanvas.height; y += gridSpacing) {
                    bgCtx.moveTo(0, y);
                    bgCtx.lineTo(backgroundCanvas.width, y);
                }
                
                bgCtx.stroke();
                
                // Draw thicker lines every 5 squares
                bgCtx.strokeStyle = '#C0C0C0';
                bgCtx.lineWidth = 1.5;
                bgCtx.beginPath();
                
                var majorSpacing = gridSpacing * 5;
                
                for (var x = majorSpacing; x < backgroundCanvas.width; x += majorSpacing) {
                    bgCtx.moveTo(x, 0);
                    bgCtx.lineTo(x, backgroundCanvas.height);
                }
                
                for (var y = majorSpacing; y < backgroundCanvas.height; y += majorSpacing) {
                    bgCtx.moveTo(0, y);
                    bgCtx.lineTo(backgroundCanvas.width, y);
                }
                
                bgCtx.stroke();
            }
            
            // Save preference
            try {
                window.localStorage.setItem('background', type);
            } catch (e) {
                // Ignore storage errors
            }
        }
        
        // Load saved background preference
        try {
            var savedBackground = window.localStorage.getItem('background');
            if (savedBackground) {
                currentBackground = savedBackground;
            }
        } catch (e) {
            // Ignore storage errors
        }
        
        resizeCanvas();
        
        var resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(resizeCanvas, 100);
        });
        
        // Save state for undo
        function saveState() {
            undoStack.push(canvas.toDataURL());
            if (undoStack.length > maxUndoSteps) {
                undoStack.shift();
            }
        }
        
        function restoreFromDataURL(dataURL) {
            var img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = dataURL;
        }
        
        // Get coordinates
        function getCoords(e) {
            var rect = canvas.getBoundingClientRect();
            var clientX, clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }
        
        // Smooth drawing during the stroke (preview)
        var lastDrawnIndex = 0;
        var tempCanvas = document.createElement('canvas');
        var tempCtx = tempCanvas.getContext('2d');
        
        function drawSmooth() {
            if (points.length < 2) return;
            
            if (currentTool === 'pen') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize;
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1;
            } else if (currentTool === 'eraser') {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = brushSize * 3;
                ctx.globalCompositeOperation = 'destination-out';
                ctx.globalAlpha = 1;
            } else if (currentTool === 'highlighter') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize * 3;
                ctx.globalCompositeOperation = 'multiply';
                ctx.globalAlpha = 0.5;
            }
            
            // Draw only new segments
            if (lastDrawnIndex === 0) {
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
            }
            
            // Use cubic Bezier curves for smoother lines
            for (var i = lastDrawnIndex; i < points.length - 1; i++) {
                var p0 = points[Math.max(0, i - 1)];
                var p1 = points[i];
                var p2 = points[i + 1];
                var p3 = points[Math.min(points.length - 1, i + 2)];
                
                // Calculate control points for cubic Bezier
                var cp1x = p1.x + (p2.x - p0.x) / 6;
                var cp1y = p1.y + (p2.y - p0.y) / 6;
                var cp2x = p2.x - (p3.x - p1.x) / 6;
                var cp2y = p2.y - (p3.y - p1.y) / 6;
                
                ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
            }
            
            ctx.stroke();
            
            // Reset composite operation for highlighter
            if (currentTool === 'highlighter') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1;
            }
            
            lastDrawnIndex = Math.max(0, points.length - 2);
        }
        
        // Smooth the collected points with moderate averaging
        function smoothPoints(pts, iterations) {
            if (pts.length < 3) return pts;
            
            var smoothed = [];
            for (var iter = 0; iter < iterations; iter++) {
                var source = (iter === 0) ? pts : smoothed;
                smoothed = [];
                
                // Keep first point
                smoothed.push(source[0]);
                
                // Average middle points with narrow window for gentle smoothing
                for (var i = 1; i < source.length - 1; i++) {
                    var x = 0;
                    var y = 0;
                    var count = 0;
                    
                    // Use 3-point window for gentler smoothing
                    for (var j = Math.max(0, i - 1); j <= Math.min(source.length - 1, i + 1); j++) {
                        var weight = 1;
                        if (j === i) weight = 2; // Give more weight to center point to preserve shape
                        x += source[j].x * weight;
                        y += source[j].y * weight;
                        count += weight;
                    }
                    
                    smoothed.push({
                        x: x / count,
                        y: y / count
                    });
                }
                
                // Keep last point
                smoothed.push(source[source.length - 1]);
            }
            
            return smoothed;
        }
        
        // Reduce number of points while maintaining shape (gentle)
        function simplifyPoints(pts) {
            if (pts.length <= 4) return pts;
            
            var simplified = [pts[0]];
            
            // Skip fewer points to preserve more detail
            for (var i = 1; i < pts.length - 1; i += 2) {
                simplified.push(pts[i]);
            }
            
            simplified.push(pts[pts.length - 1]);
            return simplified;
        }
        
        // Final smooth redraw with minimal smoothing (no shadows)
        function finalizeStroke(pts) {
            if (pts.length < 2) return;
            
            // First simplify to remove redundant points
            var simplified = simplifyPoints(pts);
            
            // Apply light smoothing (only 1 iteration)
            var smoothedPts = smoothPoints(simplified, 1);
            
            // Ensure smooth rendering properties
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
            
            if (currentTool === 'pen') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize;
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1;
            } else if (currentTool === 'highlighter') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize * 3;
                ctx.globalCompositeOperation = 'multiply';
                ctx.globalAlpha = 0.5;
            }
            
            ctx.beginPath();
            ctx.moveTo(smoothedPts[0].x, smoothedPts[0].y);
            
            // Draw with gentle Catmull-Rom curves
            var tension = 0.6;
            for (var i = 0; i < smoothedPts.length - 1; i++) {
                var p0 = smoothedPts[Math.max(0, i - 1)];
                var p1 = smoothedPts[i];
                var p2 = smoothedPts[i + 1];
                var p3 = smoothedPts[Math.min(smoothedPts.length - 1, i + 2)];
                
                var cp1x = p1.x + (p2.x - p0.x) * tension / 6;
                var cp1y = p1.y + (p2.y - p0.y) * tension / 6;
                var cp2x = p2.x - (p3.x - p1.x) * tension / 6;
                var cp2y = p2.y - (p3.y - p1.y) * tension / 6;
                
                ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
            }
            
            ctx.stroke();
            
            // Reset properties
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
            ctx.globalAlpha = 1;
        }
        
        // Filter points that are too close together
        function addPoint(point) {
            if (points.length === 0) {
                points.push(point);
                return;
            }
            
            var last = points[points.length - 1];
            var dx = point.x - last.x;
            var dy = point.y - last.y;
            var distance = Math.sqrt(dx * dx + dy * dy);
            
            // Add more points for better smoothing (lower threshold)
            if (distance > 1) {
                points.push(point);
            }
        }
        
        // Flood fill algorithm
        function floodFill(startX, startY, fillColor) {
            saveState();
            
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var pixels = imageData.data;
            var width = canvas.width;
            var height = canvas.height;
            
            startX = Math.floor(startX);
            startY = Math.floor(startY);
            
            if (startX < 0 || startX >= width || startY < 0 || startY >= height) return;
            
            var startPos = (startY * width + startX) * 4;
            var startR = pixels[startPos];
            var startG = pixels[startPos + 1];
            var startB = pixels[startPos + 2];
            var startA = pixels[startPos + 3];
            
            // Parse fill color
            var r, g, b;
            if (fillColor.indexOf('#') === 0) {
                var hex = fillColor.substring(1);
                r = parseInt(hex.substring(0, 2), 16);
                g = parseInt(hex.substring(2, 4), 16);
                b = parseInt(hex.substring(4, 6), 16);
            } else {
                r = 0; g = 0; b = 0;
            }
            
            // Check if same color
            if (startR === r && startG === g && startB === b) return;
            
            var stack = [[startX, startY]];
            var visited = {};
            
            function colorMatch(pos) {
                return pixels[pos] === startR &&
                       pixels[pos + 1] === startG &&
                       pixels[pos + 2] === startB &&
                       pixels[pos + 3] === startA;
            }
            
            while (stack.length > 0) {
                var point = stack.pop();
                var x = point[0];
                var y = point[1];
                var key = x + ',' + y;
                
                if (visited[key]) continue;
                if (x < 0 || x >= width || y < 0 || y >= height) continue;
                
                var pos = (y * width + x) * 4;
                
                if (!colorMatch(pos)) continue;
                
                visited[key] = true;
                
                pixels[pos] = r;
                pixels[pos + 1] = g;
                pixels[pos + 2] = b;
                pixels[pos + 3] = 255;
                
                stack.push([x + 1, y]);
                stack.push([x - 1, y]);
                stack.push([x, y + 1]);
                stack.push([x, y - 1]);
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        // Gradient flood fill algorithm
        function gradientFloodFill(startX, startY, color1, color2) {
            saveState();
            
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var pixels = imageData.data;
            var width = canvas.width;
            var height = canvas.height;
            
            startX = Math.floor(startX);
            startY = Math.floor(startY);
            
            if (startX < 0 || startX >= width || startY < 0 || startY >= height) return;
            
            var startPos = (startY * width + startX) * 4;
            var startR = pixels[startPos];
            var startG = pixels[startPos + 1];
            var startB = pixels[startPos + 2];
            var startA = pixels[startPos + 3];
            
            // Parse colors
            function parseColor(color) {
                if (color.indexOf('#') === 0) {
                    var hex = color.substring(1);
                    return {
                        r: parseInt(hex.substring(0, 2), 16),
                        g: parseInt(hex.substring(2, 4), 16),
                        b: parseInt(hex.substring(4, 6), 16)
                    };
                }
                return {r: 0, g: 0, b: 0};
            }
            
            var c1 = parseColor(color1);
            var c2 = parseColor(color2);
            
            var stack = [[startX, startY]];
            var visited = {};
            var filledPixels = [];
            var minX = width, maxX = 0, minY = height, maxY = 0;
            
            // More tolerant color matching to avoid white lines
            function colorMatch(pos) {
                var tolerance = 10;
                return Math.abs(pixels[pos] - startR) <= tolerance &&
                       Math.abs(pixels[pos + 1] - startG) <= tolerance &&
                       Math.abs(pixels[pos + 2] - startB) <= tolerance &&
                       pixels[pos + 3] > 0; // Only match non-transparent pixels
            }
            
            // Find all pixels to fill
            while (stack.length > 0) {
                var point = stack.pop();
                var x = point[0];
                var y = point[1];
                var key = x + ',' + y;
                
                if (visited[key]) continue;
                if (x < 0 || x >= width || y < 0 || y >= height) continue;
                
                var pos = (y * width + x) * 4;
                
                if (!colorMatch(pos)) continue;
                
                visited[key] = true;
                filledPixels.push({x: x, y: y});
                
                minX = Math.min(minX, x);
                maxX = Math.max(maxX, x);
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);
                
                stack.push([x + 1, y]);
                stack.push([x - 1, y]);
                stack.push([x, y + 1]);
                stack.push([x, y - 1]);
            }
            
            // Apply gradient with better interpolation
            var gradientWidth = maxX - minX;
            var gradientHeight = maxY - minY;
            var diagonal = Math.sqrt(gradientWidth * gradientWidth + gradientHeight * gradientHeight);
            
            for (var i = 0; i < filledPixels.length; i++) {
                var pixel = filledPixels[i];
                var dx = pixel.x - minX;
                var dy = pixel.y - minY;
                var distance = Math.sqrt(dx * dx + dy * dy);
                var ratio = diagonal > 0 ? Math.min(1, Math.max(0, distance / diagonal)) : 0;
                
                var pos = (pixel.y * width + pixel.x) * 4;
                
                // Smooth interpolation to avoid banding
                var r = Math.round(c1.r + (c2.r - c1.r) * ratio);
                var g = Math.round(c1.g + (c2.g - c1.g) * ratio);
                var b = Math.round(c1.b + (c2.b - c1.b) * ratio);
                
                pixels[pos] = r;
                pixels[pos + 1] = g;
                pixels[pos + 2] = b;
                pixels[pos + 3] = 255; // Full opacity
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        // Drawing functions
        var drawingStartState = null;
        
        function startDrawing(e) {
            e.preventDefault();
            
            var coords = getCoords(e);
            
            // Handle fill tool
            if (currentTool === 'fill') {
                floodFill(coords.x, coords.y, primaryColor);
                return;
            }
            
            // Handle gradient fill tool
            if (currentTool === 'gradientFill') {
                gradientFloodFill(coords.x, coords.y, primaryColor, secondaryColor);
                return;
            }
            
            isDrawing = true;
            points = [];
            lastDrawnIndex = 0;
            points.push(coords);
            
            // Save state before drawing
            drawingStartState = canvas.toDataURL();
            
            // Draw initial point
            if (currentTool === 'pen') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize;
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1;
            } else if (currentTool === 'eraser') {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = brushSize * 3;
                ctx.globalCompositeOperation = 'destination-out';
                ctx.globalAlpha = 1;
            } else if (currentTool === 'highlighter') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize * 3;
                ctx.globalCompositeOperation = 'multiply';
                ctx.globalAlpha = 0.5;
            }
            ctx.beginPath();
            ctx.arc(coords.x, coords.y, brushSize / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
        }
        
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            var coords = getCoords(e);
            addPoint(coords);
            
            if (points.length >= 2) {
                drawSmooth();
            }
        }
        
        function stopDrawing(e) {
            if (isDrawing) {
                e.preventDefault();
                isDrawing = false;
                
                // For eraser, don't redraw - just save the current state
                if (currentTool === 'eraser') {
                    saveState();
                    points = [];
                    lastDrawnIndex = 0;
                    drawingStartState = null;
                } else if (drawingStartState && points.length >= 2) {
                    // For other tools, restore and redraw with smoothing
                    var img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        
                        // Draw final smoothed and anti-aliased stroke
                        finalizeStroke(points);
                        
                        // Save for undo
                        saveState();
                        
                        points = [];
                        lastDrawnIndex = 0;
                        drawingStartState = null;
                    };
                    img.src = drawingStartState;
                } else {
                    // Single point or very short stroke
                    saveState();
                    points = [];
                    lastDrawnIndex = 0;
                    drawingStartState = null;
                }
            }
        }
        
        // Events
        canvas.addEventListener('touchstart', startDrawing, false);
        canvas.addEventListener('touchmove', draw, false);
        canvas.addEventListener('touchend', stopDrawing, false);
        canvas.addEventListener('touchcancel', stopDrawing, false);
        
        canvas.addEventListener('mousedown', startDrawing, false);
        canvas.addEventListener('mousemove', draw, false);
        canvas.addEventListener('mouseup', stopDrawing, false);
        canvas.addEventListener('mouseleave', stopDrawing, false);
        
        // Tool buttons
        document.getElementById('penBtn').addEventListener('click', function() {
            currentTool = 'pen';
            this.className = 'tool-btn active';
            document.getElementById('eraserBtn').className = 'tool-btn';
            document.getElementById('fillBtn').className = 'tool-btn';
            document.getElementById('gradientFillBtn').className = 'tool-btn';
            document.getElementById('highlighterBtn').className = 'tool-btn';
        });
        
        document.getElementById('eraserBtn').addEventListener('click', function() {
            currentTool = 'eraser';
            this.className = 'tool-btn active';
            document.getElementById('penBtn').className = 'tool-btn';
            document.getElementById('fillBtn').className = 'tool-btn';
            document.getElementById('gradientFillBtn').className = 'tool-btn';
            document.getElementById('highlighterBtn').className = 'tool-btn';
        });
        
        document.getElementById('fillBtn').addEventListener('click', function() {
            currentTool = 'fill';
            this.className = 'tool-btn active';
            document.getElementById('penBtn').className = 'tool-btn';
            document.getElementById('eraserBtn').className = 'tool-btn';
            document.getElementById('gradientFillBtn').className = 'tool-btn';
            document.getElementById('highlighterBtn').className = 'tool-btn';
        });
        
        document.getElementById('gradientFillBtn').addEventListener('click', function() {
            currentTool = 'gradientFill';
            this.className = 'tool-btn active';
            document.getElementById('penBtn').className = 'tool-btn';
            document.getElementById('eraserBtn').className = 'tool-btn';
            document.getElementById('fillBtn').className = 'tool-btn';
            document.getElementById('highlighterBtn').className = 'tool-btn';
        });
        
        document.getElementById('highlighterBtn').addEventListener('click', function() {
            currentTool = 'highlighter';
            this.className = 'tool-btn active';
            document.getElementById('penBtn').className = 'tool-btn';
            document.getElementById('eraserBtn').className = 'tool-btn';
            document.getElementById('fillBtn').className = 'tool-btn';
            document.getElementById('gradientFillBtn').className = 'tool-btn';
        });
        
        // Color Palette
        var colorPalette = document.getElementById('colorPalette');
        var colorPaletteBtn = document.getElementById('colorPaletteBtn');
        var primaryColorBtn = document.getElementById('primaryColorBtn');
        var secondaryColorBtn = document.getElementById('secondaryColorBtn');
        
        // Switch between primary and secondary color
        primaryColorBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            activeColorSlot = 'primary';
            currentColor = primaryColor;
            primaryColorBtn.style.border = '3px solid #FFD700';
            secondaryColorBtn.style.border = '2px solid rgba(0,0,0,0.5)';
        });
        
        secondaryColorBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            activeColorSlot = 'secondary';
            currentColor = secondaryColor;
            secondaryColorBtn.style.border = '3px solid #FFD700';
            primaryColorBtn.style.border = '2px solid rgba(255,255,255,0.9)';
        });
        
        // Toggle color palette
        colorPaletteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (colorPalette.className === 'show') {
                colorPalette.className = '';
            } else {
                colorPalette.className = 'show';
            }
        });
        
        // Close palette when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== colorPaletteBtn && !colorPalette.contains(e.target)) {
                colorPalette.className = '';
            }
        });
        
        // Color selection
        var colorBtns = document.querySelectorAll('#colorPalette .color-btn');
        for (var i = 0; i < colorBtns.length; i++) {
            colorBtns[i].addEventListener('click', function() {
                var selectedColor = this.getAttribute('data-color');
                
                // Apply to active color slot
                if (activeColorSlot === 'primary') {
                    primaryColor = selectedColor;
                    primaryColorBtn.querySelector('div').style.background = primaryColor;
                    currentColor = primaryColor;
                } else {
                    secondaryColor = selectedColor;
                    secondaryColorBtn.querySelector('div').style.background = secondaryColor;
                    currentColor = secondaryColor;
                }
                
                // Don't change tool if fill, gradient fill, or highlighter are active
                if (currentTool !== 'fill' && currentTool !== 'gradientFill' && currentTool !== 'highlighter') {
                currentTool = 'pen';
                    document.getElementById('penBtn').className = 'tool-btn active';
                    document.getElementById('eraserBtn').className = 'tool-btn';
                    document.getElementById('fillBtn').className = 'tool-btn';
                    document.getElementById('gradientFillBtn').className = 'tool-btn';
                    document.getElementById('highlighterBtn').className = 'tool-btn';
                }
                
                // Update active state
                var allColorBtns = document.querySelectorAll('#colorPalette .color-btn');
                for (var j = 0; j < allColorBtns.length; j++) {
                    allColorBtns[j].className = 'color-btn';
                }
                this.className = 'color-btn active';
                
                // Close palette
                colorPalette.className = '';
            });
        }
        
        // Size buttons
        var sizeBtns = document.querySelectorAll('.size-btn');
        for (var i = 0; i < sizeBtns.length; i++) {
            sizeBtns[i].addEventListener('click', function() {
                brushSize = parseInt(this.getAttribute('data-size'));
                
                var allSizeBtns = document.querySelectorAll('.size-btn');
                for (var j = 0; j < allSizeBtns.length; j++) {
                    allSizeBtns[j].className = 'tool-btn size-btn';
                }
                this.className = 'tool-btn size-btn active';
            });
        }
        
        // Settings Panel
        var settingsPanel = document.getElementById('settingsPanel');
        var settingsBtn = document.getElementById('settingsBtn');
        
        // Toggle settings panel
        settingsBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (settingsPanel.className === 'show') {
                settingsPanel.className = '';
            } else {
                settingsPanel.className = 'show';
                // Close color palette if open
                colorPalette.className = '';
            }
        });
        
        // Close settings when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== settingsBtn && !settingsPanel.contains(e.target)) {
                settingsPanel.className = '';
            }
        });
        
        // Background selection
        var bgBtns = document.querySelectorAll('.setting-option');
        for (var i = 0; i < bgBtns.length; i++) {
            bgBtns[i].addEventListener('click', function() {
                var bgType = this.getAttribute('data-background');
                drawBackground(bgType);
                
                // Update active state
                var allBgBtns = document.querySelectorAll('.setting-option');
                for (var j = 0; j < allBgBtns.length; j++) {
                    allBgBtns[j].className = 'setting-option';
                }
                this.className = 'setting-option active';
            });
        }
        
        // Set initial active background button
        var savedBg = currentBackground;
        var allBgBtns = document.querySelectorAll('.setting-option');
        for (var i = 0; i < allBgBtns.length; i++) {
            if (allBgBtns[i].getAttribute('data-background') === savedBg) {
                allBgBtns[i].className = 'setting-option active';
            } else {
                allBgBtns[i].className = 'setting-option';
            }
        }
        
        // New button
        document.getElementById('newBtn').addEventListener('click', function() {
            if (confirm('Vuoi creare un nuovo disegno? Non salvato = perso!')) {
                undoStack = [];
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        });
        
        // Undo button
        document.getElementById('undoBtn').addEventListener('click', function() {
            if (undoStack.length > 1) {
                undoStack.pop();
                restoreFromDataURL(undoStack[undoStack.length - 1]);
            } else if (undoStack.length === 1) {
                undoStack.pop();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        });
        
        // Modal functions
        function openModal() {
            modal.className = 'show';
        }
        
        function closeModal() {
            modal.className = '';
        }
        
        document.getElementById('closeModal').addEventListener('click', closeModal);
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // localStorage functions
        function getAllDrawings() {
            try {
                var drawings = window.localStorage.getItem('drawings');
                return drawings ? JSON.parse(drawings) : [];
            } catch (e) {
                return [];
            }
        }
        
        function saveAllDrawings(drawings) {
            try {
                window.localStorage.setItem('drawings', JSON.stringify(drawings));
            } catch (e) {
                alert('Errore nel salvataggio');
            }
        }
        
        // Download button - scarica immediatamente il disegno corrente
        document.getElementById('downloadBtn').addEventListener('click', function() {
                var dataURL = canvas.toDataURL('image/png');
            var link = document.createElement('a');
            link.download = 'disegno_' + new Date().getTime() + '.png';
            link.href = dataURL;
            link.click();
        });
        
        // Load button
        document.getElementById('loadBtn').addEventListener('click', function() {
            var drawings = getAllDrawings();
            var modalBody = document.getElementById('modalBody');
            document.getElementById('modalTitle').textContent = 'I Miei Disegni';
            
            if (drawings.length === 0) {
                modalBody.innerHTML = '<p style="padding:20px;text-align:center">Nessun disegno salvato</p>';
            } else {
                var html = '';
                for (var i = drawings.length - 1; i >= 0; i--) {
                    var drawing = drawings[i];
                    var date = new Date(drawing.date);
                    var dateStr = date.getDate() + '/' + (date.getMonth()+1) + '/' + date.getFullYear() + ' ' + 
                                  date.getHours() + ':' + (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
                    
                    html += '<div class="saved-item">' +
                        '<img src="' + drawing.data + '" class="saved-preview">' +
                        '<div class="saved-info"><strong>' + drawing.name + '</strong><br>' + dateStr + '</div>' +
                        '<button class="btn" onclick="loadDrawing(' + drawing.id + ')">Carica</button> ' +
                        '<button class="btn" onclick="downloadDrawing(' + drawing.id + ')">Scarica</button> ' +
                        '<button class="btn" onclick="deleteDrawing(' + drawing.id + ')">Elimina</button>' +
                        '</div>';
                }
                modalBody.innerHTML = html;
            }
            
            openModal();
        });
        
        // Global functions for onclick
        function loadDrawing(id) {
            var drawings = getAllDrawings();
            for (var i = 0; i < drawings.length; i++) {
                if (drawings[i].id === id) {
                    restoreFromDataURL(drawings[i].data);
                    saveState();
                    closeModal();
                    return;
                }
            }
        }
        
        function downloadDrawing(id) {
            var drawings = getAllDrawings();
            for (var i = 0; i < drawings.length; i++) {
                if (drawings[i].id === id) {
                    var link = document.createElement('a');
                    link.download = drawings[i].name + '.png';
                    link.href = drawings[i].data;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    return;
                }
            }
        }
        
        function deleteDrawing(id) {
            if (confirm('Vuoi eliminare questo disegno?')) {
                var drawings = getAllDrawings();
                var newDrawings = [];
                for (var i = 0; i < drawings.length; i++) {
                    if (drawings[i].id !== id) {
                        newDrawings.push(drawings[i]);
                    }
                }
                saveAllDrawings(newDrawings);
                document.getElementById('loadBtn').click();
            }
        }
        
        // Prevent scrolling
        document.body.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, false);
    </script>
</body>
</html>
